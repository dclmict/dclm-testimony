project:    dclm-testimony
repo:       https://github.com/dclmict/dclm-testimony
url:        https://testimony.dclm.org
url:        https://gckhq.org/testimony


-- id
id:         dclmict@gmail.com
pass:       Mercy0Lord
url:        https://testimony.dclm.org/admin
url:        https://gckhq.org/testimony/login
url:	      https://testimony.dclm.org/register
+
- app url
dev
url:    https://testimony
url:    https://testimony/admin
url:    https://127.0.0.1:4443
url:    https://127.0.0.1:4443/admin
url:    https://code/testimony/
url:    https://code/testimony/admin


-- setup repo
cd ~/dev/code/dclm/testimony.dclm.org
git add . && git commit -m "first commit"
gh repo create dclmict/dclm-testimony --public --source=. --remote=origin
git push --set-upstream origin main
git push


-- dockerise app
- build image
docker build -t testimony-app .
docker tag testimony-app opeoniye/testimony-app:latest
+
- push image
docker images
docker login -u opeoniye
18bceabe-22bc-4acf-bf88-69fea02aad3f
docker push opeoniye/testimony-app


-- run project on dev(docker)
- run container
touch Makefile
cp ./src/.env.example ./src/.env.dev
make dev
make key
make migrate
make fresh
make seed
make version
make bams
make ddev
make logdev
+
- check db access inside container
php artisan tinker
\DB::select('show tables');
+
- check container logs
make logdev


-- deploy project to production(monolith)
cd /var/www/dclm-testimony
git clone git@github.com:dclmict/dclm-testimony.git dclm-testimony
sudo chown -R ubuntu:ubuntu . \
&& sudo find . -type d -exec sudo chmod 775 {} \; \
&& sudo find . -type f -exec sudo chmod 664 {} \;
sudo chgrp -R www-data storage bootstrap/cache \
&& sudo chmod -R ug+rwx storage bootstrap/cache
cp .env.example .env && vim .env
composer install
php artisan key:generate
php artisan migrate
php artisan migrate:fresh
php artisan db:seed
php artisan db:seed --class=RoleSeeder 
php artisan optimize:clear
php artisan --version
+
- to update database
php artisan migrate
+
cd /var/www/dclm-testimony
git pull


-- deploy project to production(docker)
mkdir -p /var/docker/dclm-testimony
git clone https://github.com/dclmict/dclm-testimony.git .
sudo chown -R ubuntu:ubuntu .
cp .env.example .env && vim .env
make prod
make key
make aws
make dprod
make logprod
+
- setup database
make migrate
make seed
make fresh
make version
+
- nginx config
ref: https://laravel.com/docs/9.x/deployment#nginx
sudo vim /etc/nginx/conf.d/dclm.conf
# TESTIMONY.DCLM.ORG
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name    testimony.dclm.org;
    error_log      /var/log/nginx/testimony.log debug;

    location / {
      proxy_pass https://localhost:4004;
      include /etc/nginx/proxy_params;
      add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
    }

    include global/noway.conf;
    include global/security.conf;
    ssl_certificate /etc/letsencrypt/live/dclm.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dclm.org/privkey.pem;
    include /etc/nginx/global/ssl.conf;    
}


-- deploy project to production(kubernetes)




-- check s3 bucket
aws s3 ls dclm-developers/dclm-testimony/ --profile dclm
aws s3 ls dclm-developers/dclm-testimony/'GCK October Edition'/ --profile dclm



-- issues
E: mixed content issue with https and http with nginx reverse proxy config
A: add "add_header 'Content-Security-Policy' 'upgrade-insecure-requests';" inside the location block


- cmds
docker compose logs -f testimony-app
docker compose restart testimony-app
docker compose exec -it testimony-app bash
+
docker compose exec testimony-app bash -c "find . -type d -exec chmod 775 {} \;"
docker compose exec testimony-app bash -c "find . -type f -exec chmod 664 {} \;"
docker compose exec testimony-app bash -c "chgrp -R nginx storage bootstrap/cache"
docker compose exec testimony-app bash -c "chmod -R ug+rwx storage bootstrap/cache"
docker compose exec testimony-app bash -c "curl localhost"
docker compose exec testimony-app bash -c "sleep 10"
+
- letsencrypt folder perm
ref: https://stackoverflow.com/a/69055987
sudo chmod +x /etc/letsencrypt/live/dclm.org
sudo chmod +x /etc/letsencrypt/live
sudo chmod +x /etc/letsencrypt/

- laravel logs
docker compose exec -it testimony-app bash
tail -f storage/logs/laravel.log


#https://laravel.com/docs/9.x/deployment#nginx